name: Release Manager

on:
  push:
    tags:
      - "v[0-9]+\\.[0-9]+\\.[0-9]+"  # âœ… ä¸¥æ ¼åŒ¹é…å®Œæ•´ SemVer (ä¾‹å¦‚ v1.2.3)

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag_version.outputs.LATEST_TAG }}  # ğŸ’ ç¡®ä¿ç‰ˆæœ¬é€ä¼ 
    
    steps:
      - name: Checkout Code
        # âš¡ï¸ ç»Ÿä¸€ä½¿ç”¨æœ€æ–° Checkout Action ç‰ˆæœ¬
        uses: actions/checkout@v4
        with:
          # ğŸ“œ å…³é”®é…ç½®ï¼šå¿…é¡»è·å–å…¨éƒ¨æäº¤å†å²æ‰èƒ½ä½¿ç”¨ git-describe
          fetch-depth: 0  

      - name: Extract Tag Version
        id: tag_version  # ğŸ”‘ å®šä¹‰æ­¥éª¤å”¯ä¸€æ ‡è¯†ç¬¦
        run: |
          # ğŸ“Œ å¯é è·å–æœ‰æ•ˆ tag çš„æ–¹æ¡ˆ (å…¼å®¹é¦–æ¬¡æ¨é€æƒ…å†µ)
          git fetch --force --tags  # å¼ºåˆ¶åˆ·æ–° Tag åˆ—è¡¨
          # ğŸ‘‰ å‡†ç¡®è·å– HEAD æ‰€åœ¨çš„ tag (ä¸å« commit hash)
          CLEAN_TAG=$(git describe --tags --exact-match 2>/dev/null || echo ${{ github.ref_name }})
          
          # ğŸ” å…¼å®¹å¤„ç†å¸¦ v å‰ç¼€çš„æƒ…å†µï¼ˆä¾‹å¦‚åŸæœ¬æœ‰è¾“å…¥væˆ–æ²¡æœ‰ï¼‰
          FINAL_VER=$(echo "$CLEAN_TAG" | sed 's/^v//')  # è§„èŒƒåŒ–ç‰ˆæœ¬å·
          
          # ğŸ“¤ æ ‡å‡†åŒ–è¾“å‡ºå˜é‡ (æ³¨æ„ï¼šå¿…é¡»å­˜è‡³ GITHUB_OUTPUT) 
          echo "LATEST_TAG=$FINAL_VER" >> $GITHUB_OUTPUT 

      - name: Build and Save Docker Image
        working-directory: .  # ğŸ–¥ æ˜ç¡®å®šä¹‰æ„å»ºä¸Šä¸‹æ–‡
        env:
          DOCKER_TAG: ${{ steps.tag_version.outputs.LATEST_TAG }}
        run: |
          mkdir -p dist
          # ğŸ¯ Buildx æ‰©å±•æ–¹æ³•æ›´æ ‡å‡† (å¦‚éœ€æ›´ä¼˜é›…å¯å¢åŠ ç¼“å­˜æœºåˆ¶)
          docker build . \
            --tag avdc-docker:${{ env.DOCKER_TAG }} \
            --file ${{ github.workspace }}/Dockerfile  
          
          # ğŸ—œï¸ å‹ç¼©æ–¹æ¡ˆå…¼å®¹æ€§ä¼˜åŒ– (æ¨èæ ‡å‡† tar.gz)
          docker save avdc-docker:${{ env.DOCKER_TAG }} | \ 
            gzip > dist/avdc-docker_${{ env.DOCKER_TAG }}.tar.gz

  publish-release:
    needs: [build]  # â›“ ä¸¥æ ¼æŒ‰ç…§æ­¥éª¤æ‰§è¡Œé¡ºåº
    runs-on: ubuntu-latest
    # ğŸ’¡ å¤šæ¡ä»¶æ ¡éªŒæ›´ç¨³å¥ (ç¡®ä¿ä»…åœ¨åˆæ³• tag äº‹ä»¶å“åº”)
    if: |
      startsWith(github.ref, 'refs/tags/') &&
      github.event_name == 'push'
      
    steps:
      - name: Generate Dynamic Changelog (æ™ºèƒ½å†å²è¿½æº¯)
        env:
          VERSION_TAG: ${{ needs.build.outputs.image_tag }}
          USE_BETA_TEST_TAG: ${{ contains(needs.build.outputs.image_tag, 'beta') }}
        run: |
          LAST_PROD_TAG=$(git describe --abbrev=0 --match='v*[0-9]' 2>/dev/null || echo "")
          
          # ğŸ¤– åŠ¨æ€é€‰æ‹©å¯¹æ¯”åŸºå‡† Tagï¼š
          #   å½“æœ€æ–°ç‰ˆæœ¬æ˜¯ beta æµ‹è¯•ç‰ˆæœ¬æ—¶ï¼Œæ¯”è¾ƒä¸æ­£å¼ç‰ˆçš„å·®å¼‚
          #   è‹¥å‘å¸ƒæ­£å¼ç‰ˆåˆ™ä¸å‰ä¸€ä¸ªæ­£å¼ç‰ˆæ¯”è¾ƒ
          COMPARE_POINT=${LAST_PROD_TAG}
          
          echo "# æ­£å¼å‘å¸ƒ $VERSION_TAG" > changelog.md
          
          if ! git rev-list -n 1 "$COMPARE_POINT" &>/dev/null || [ -z "$COMPARE_POINT" ]; then
            echo "ğŸ”” å†å²ç‰ˆæœ¬å·ä¸å­˜åœ¨ï¼Œç”Ÿæˆå…¨é‡æ—¥å¿—..."
            git log --oneline --decorate >> changelog.md
          else
            # ğŸ•˜ TimeBasedæ ¼å¼ï¼š"%ad %h %s"
            LOG_CMD="git log \"$COMPARE_POINT..HEAD\" --oneline --date=iso-strict"
            echo "## å¯¹æ¯”åŒºé—´ï¼š$COMPARE_POINT â” $VERSION_TAG" >> changelog.md  
            $LOG_CMD >> changelog.md
          fi
          
          # ğŸ›¸ åŒ…å«å®¹å™¨é•œåƒå“ˆå¸Œä½œä¸ºè¿½è¸ªæ ‡è¯†
          echo -e "\nğŸ“¦ Docker é•œåƒ ID: $(docker inspect avdc-docker:$VERSION_TAG --format '{{ .Id }}')" >> changelog.md

      - name: GH Release with Upload
        # ğŸ“¦ å¼ºçƒˆæ¨èä½¿ç”¨æ”¯æŒç¼“å­˜ã€å¹‚ç­‰ä¸Šä¼ çš„æ–°ç‰ˆæœ¬ Action
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true  # ğŸš¨ å…è®¸æ›´æ–°å·²æœ‰ Release (åº”å¯¹åŒåæƒ…å†µ)
          artifactErrorsFailBuild: false  # ğŸŸ¢ å®¹å¿éƒ¨åˆ†ä¸Šä¼ å¤±è´¥
          artifacts: "dist/avdc-docker_${{ needs.build.outputs.image_tag }}.tar.gz"  
          bodyFile: changelog.md  
          name: ${{ format('Release v{0}', needs.build.outputs.image_tag) }}  
          prerelease: ${{ contains(needs.build.outputs.image_tag, '-beta') }}  
          tag: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PA_TOKEN }}  # ğŸ” ä½¿ç”¨è‡ªå®šä¹‰ Token æ›´å¯æ§
