name: Release Pipeline

# ğŸ“Œ ä»…å¯¹æ ‡ç­¾æ¨é€è§¦å‘å¹¶éœ€é€šè¿‡ build é˜¶æ®µ
on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Build Artifacts
        run: echo "Simulating build process..." && mkdir -p dist && touch dist/app-${GITHUB_REF#refs/tags/}.zip

  # ğŸš€ å®šä¹‰ GitHub Release å‘å¸ƒæ¨¡å—
  publish-release:
    needs: [build]  # å¿…é¡»ç­‰å¾… build é˜¶æ®µå®Œæˆ
    runs-on: ubuntu-latest
    # ğŸ§· ä»…åœ¨æ ‡ç­¾äº‹ä»¶æ—¶è§¦å‘ (åŒé‡éªŒè¯ï¼Œå³ä¾¿ workflow é€šè¿‡æ ‡ç­¾çº¦æŸä¹Ÿå»ºè®®ä¿ç•™)
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      # â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ­£ç‚¹ (ç¼ºå°‘æ­¤æ­¥éª¤ä¼šå¯¼è‡´æ‰€æœ‰ git æ“ä½œå¤±è´¥) â–¼â–¼â–¼
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0    # ğŸ”¥ å¿…é¡»è®¾ä¸º0æ‰èƒ½è·å–å®Œæ•´çš„tagå’Œå†å²è®°å½•
      
      - name: Generate Changelog
        run: |
          # ğŸ’¡ ä¼˜é›…å¤„ç†é¦–æ¬¡tagç‰ˆæœ¬æ—¥å¿—
          echo "# å˜æ›´æ—¥å¿— (ç‰ˆæœ¬ ${{ github.ref_name }})" > changelog.md
          LATEST_TAG=$(git describe --tags --abbrev=0)          
          if [ -z "$(git tag --list)" ]; then
            # â¤ å¦‚æœæ˜¯é¦–ä¸ªæ ‡ç­¾ï¼šå…¨å†å²æ—¥å¿—
            git log --oneline | sed 's/^/> /' >> changelog.md
          else
            # â¤ å¸¸è§„æƒ…å†µï¼šä¸ä¸Šä¸ªæ­£å¼ç‰ˆæœ¬å¯¹æ¯”
            PREV_TAG=$(git describe --tags --abbrev=0 ${LATEST_TAG}^) || true
            if [ -z "$PREV_TAG" ]; then
              # ğŸ“Œ æ— ä¸Šä¸€ä¸ªç¨³å®štagæ—¶ï¼ˆå¦‚é¦–ä¸ªæ­£å¼æ ‡ç­¾å‰çš„betaç‰ˆæœ¬ï¼‰ï¼Œä»å…¨é‡è®°å½•
              PREV_TAG=$(git rev-list --max-parents=0 HEAD) 
            fi
            echo "## å˜æ›´èŒƒå›´ï¼š[$PREV_TAG â¡ $LATEST_TAG]" >> changelog.md
            git log ${PREV_TAG}..${LATEST_TAG} --oneline --no-decorate | sed 's/^/- /' >> changelog.md
          fi

          # ğŸ•µï¸ è°ƒè¯•è¾“å‡ºï¼ˆå®‰å…¨æŸ¥çœ‹å†…å®¹ï¼‰
          cat changelog.md | head -n 5
          
      # â–¼â–¼â–¼ æ­£å¼å‘å¸ƒæ¨¡å—ï¼ˆä½¿ç”¨å®˜æ–¹æ¨èçš„æœ€æ–° action ç‰ˆæœ¬ï¼‰ â–¼â–¼â–¼
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "ğŸ‰ Release ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}     # ç›´æ¥æå–è§¦å‘çš„å·¥ä½œæµæ ‡ç­¾å
          body_path: changelog.md              # å¼•å…¥åŠ¨æ€ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶
          draft: false                         # ç«‹å³å‘å¸ƒ
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          files: |
            dist/app-${{ github.ref_name }}.zip  # âœ” è‡ªåŠ¨åŒ¹é…æ„å»ºäº§ç‰©
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
